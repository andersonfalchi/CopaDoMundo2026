@page "/registro"
@using CopaMundo2026.Models

@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>Cadastro - Bol√£o da Copa</PageTitle>

<div class="login-container">
    <div class="video-side register-side">
        <div class="register-content">
            <div class="register-icon">üèÜ</div>
            <h1 class="register-title">Entre para o Bol√£o!</h1>
            <p class="register-subtitle">Crie sua conta e participe</p>
            <div class="register-features">
                <div class="feature-item">‚öΩ Palpites da Copa 2026</div>
                <div class="feature-item">üèÜ Ranking de Acertos</div>
                <div class="feature-item">üéØ Desafie seus Amigos</div>
                <div class="feature-item">ü•á Pr√™mios Incr√≠veis</div>
            </div>
        </div>
    </div>

    <div class="form-side">
        <div class="form-container">
            <div class="form-header">
                <div class="logo-icon">üéØ</div>
                <h2 class="form-title">CRIAR CONTA</h2>
                <p class="form-subtitle">Fa√ßa parte do melhor bol√£o da Copa</p>
            </div>

            <EditForm Model="@registroModel" OnValidSubmit="@RealizarRegistro" class="login-form">
                <DataAnnotationsValidator />

                @if (!string.IsNullOrEmpty(mensagemErro))
                {
                    <div class="alert alert-error">
                        <span class="alert-icon">‚ùå</span>
                        <span>@mensagemErro</span>
                    </div>
                }

                @if (!string.IsNullOrEmpty(mensagemSucesso))
                {
                    <div class="alert alert-success">
                        <span class="alert-icon">‚úÖ</span>
                        <span>@mensagemSucesso</span>
                    </div>
                }

                <div class="form-group">
                    <label class="form-label">
                        <span class="label-icon">üë§</span>
                        Nome de Usu√°rio
                    </label>
                    <div class="input-wrapper">
                        <InputText @bind-Value="registroModel.NomeUsuario"
                                   @bind-Value:after="VerificarNomeUsuario"
                                   class="form-input"
                                   placeholder="Digite um nome √∫nico"
                                   disabled="@carregando" />
                    </div>
                    <ValidationMessage For="@(() => registroModel.NomeUsuario)" class="validation-message" />
                    @if (verificandoNome)
                    {
                        <span class="input-hint">üîÑ Verificando disponibilidade...</span>
                    }
                    else if (!string.IsNullOrEmpty(registroModel.NomeUsuario) && nomeDisponivel)
                    {
                        <span class="input-hint success">‚úÖ Nome dispon√≠vel!</span>
                    }
                    else if (!string.IsNullOrEmpty(registroModel.NomeUsuario) && !nomeDisponivel)
                    {
                        <span class="input-hint error">‚ùå Nome j√° est√° em uso</span>
                    }
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <span class="label-icon">üîí</span>
                        Senha
                    </label>
                    <div class="input-wrapper">
                        <InputText @bind-Value="registroModel.Senha"
                                   type="password"
                                   class="form-input"
                                   placeholder="M√≠nimo 6 caracteres"
                                   disabled="@carregando" />
                    </div>
                    <ValidationMessage For="@(() => registroModel.Senha)" class="validation-message" />
                    @if (!string.IsNullOrEmpty(registroModel.Senha))
                    {
                        <div class="password-strength">
                            <div class="strength-bar">
                                <div class="strength-fill" style="width: @ObterForcaSenha()%; background-color: @ObterCorForcaSenha();"></div>
                            </div>
                            <span class="input-hint">For√ßa: @ObterTextoForcaSenha()</span>
                        </div>
                    }
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <span class="label-icon">üîí</span>
                        Confirmar Senha
                    </label>
                    <div class="input-wrapper">
                        <InputText @bind-Value="registroModel.ConfirmaSenha"
                                   type="password"
                                   class="form-input"
                                   placeholder="Digite novamente"
                                   disabled="@carregando" />
                    </div>
                    <ValidationMessage For="@(() => registroModel.ConfirmaSenha)" class="validation-message" />
                    @if (!string.IsNullOrEmpty(registroModel.ConfirmaSenha) && registroModel.Senha == registroModel.ConfirmaSenha)
                    {
                        <span class="input-hint success">‚úÖ Senhas coincidem</span>
                    }
                </div>

                <button type="submit" class="btn-login" disabled="@(carregando || !nomeDisponivel)">
                    @if (carregando)
                    {
                        <span class="btn-spinner">‚öΩ</span>
                        <span>CRIANDO...</span>
                    }
                    else
                    {
                        <span>CRIAR CONTA</span>
                        <span class="btn-arrow">‚Üí</span>
                    }
                </button>
            </EditForm>

            <div class="form-divider">
                <span>j√° tem conta?</span>
            </div>

            <button class="btn-register" @onclick="IrParaLogin" disabled="@carregando">
                <span>Fazer Login</span>
            </button>

            <div class="form-footer">
                <p>‚öΩ Fa√ßa parte da maior torcida! ‚öΩ</p>
            </div>
        </div>
    </div>
</div>

@code {
    private RegistroDTO registroModel = new();
    private string mensagemErro = string.Empty;
    private string mensagemSucesso = string.Empty;
    private bool carregando = false;
    private bool verificandoNome = false;
    private bool nomeDisponivel = true;
    private System.Threading.Timer? verificacaoTimer;

    private async Task RealizarRegistro()
    {
        mensagemErro = string.Empty;
        mensagemSucesso = string.Empty;
        carregando = true;

        try
        {
            // var (sucesso, mensagem) = await AuthService.RegistrarAsync(registroModel);

            // if (sucesso)
            // {
            //     mensagemSucesso = mensagem;
            //     await Task.Delay(2000);
            //     Navigation.NavigateTo("/login");
            // }
            // else
            // {
            //     mensagemErro = mensagem;
            // }
        }
        finally
        {
            carregando = false;
        }
    }

    private void VerificarNomeUsuario()
    {
        if (string.IsNullOrWhiteSpace(registroModel.NomeUsuario))
        {
            nomeDisponivel = true;
            return;
        }

        verificandoNome = true;
        verificacaoTimer?.Dispose();

        verificacaoTimer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(() =>
            {
                // nomeDisponivel = AuthService.VerificarNomeUsuarioDisponivel(registroModel.NomeUsuario);
                verificandoNome = false;
                StateHasChanged();
            });
        }, null, 500, System.Threading.Timeout.Infinite);
    }

    private int ObterForcaSenha()
    {
        if (string.IsNullOrEmpty(registroModel.Senha)) return 0;

        int forca = 0;
        if (registroModel.Senha.Length >= 6) forca += 25;
        if (registroModel.Senha.Length >= 8) forca += 25;
        if (registroModel.Senha.Any(char.IsDigit)) forca += 25;
        if (registroModel.Senha.Any(char.IsUpper)) forca += 25;

        return forca;
    }

    private string ObterCorForcaSenha()
    {
        var forca = ObterForcaSenha();
        if (forca <= 25) return "#ef4444";
        if (forca <= 50) return "#f59e0b";
        if (forca <= 75) return "#3b82f6";
        return "#10b981";
    }

    private string ObterTextoForcaSenha()
    {
        var forca = ObterForcaSenha();
        if (forca <= 25) return "Fraca ‚ö†Ô∏è";
        if (forca <= 50) return "M√©dia üìä";
        if (forca <= 75) return "Boa üëç";
        return "Forte üí™";
    }

    private void IrParaLogin()
    {
        Navigation.NavigateTo("/login");
    }

    public void Dispose()
    {
        verificacaoTimer?.Dispose();
    }
}
